#!/usr/bin/env python3
"""
PDCA Shell åŸ·è¡Œè…³æœ¬
æ”¯æ´ Claude CLI çš„ !pdca æŒ‡ä»¤å‰ç¶´
"""

import sys
import json
import asyncio
from datetime import datetime
from pathlib import Path

# æ·»åŠ ç•¶å‰ç›®éŒ„åˆ° Python è·¯å¾‘
sys.path.insert(0, str(Path(__file__).parent))

def create_task_file(task_description):
    """å‰µå»ºä»»å‹™æª”æ¡ˆä¾› Claude è®€å–"""
    pdca_dir = Path(".pdca")
    pdca_dir.mkdir(exist_ok=True)
    
    task_data = {
        "task": task_description,
        "created_at": datetime.now().isoformat(),
        "status": "initiated",
        "source": "shell_command"
    }
    
    # ä¿å­˜ç•¶å‰ä»»å‹™
    with open(pdca_dir / "current_task.json", "w", encoding="utf-8") as f:
        json.dump(task_data, f, indent=2, ensure_ascii=False)
    
    return task_data

def show_status():
    """é¡¯ç¤ºç•¶å‰ä»»å‹™ç‹€æ…‹"""
    pdca_dir = Path(".pdca")
    current_task_file = pdca_dir / "current_task.json"
    
    if not current_task_file.exists():
        print("ğŸ“Š ç›®å‰æ²’æœ‰é€²è¡Œä¸­çš„ PDCA ä»»å‹™")
        return
    
    with open(current_task_file, "r", encoding="utf-8") as f:
        task_data = json.load(f)
    
    print("ğŸ“Š PDCA ä»»å‹™ç‹€æ…‹")
    print("=" * 40)
    print(f"ä»»å‹™: {task_data.get('task', 'N/A')}")
    print(f"ç‹€æ…‹: {task_data.get('status', 'unknown')}")
    print(f"å»ºç«‹æ™‚é–“: {task_data.get('created_at', 'N/A')}")

def stop_task():
    """åœæ­¢ç•¶å‰ä»»å‹™"""
    pdca_dir = Path(".pdca")
    current_task_file = pdca_dir / "current_task.json"
    
    if current_task_file.exists():
        current_task_file.unlink()
        print("ğŸ›‘ PDCA ä»»å‹™å·²åœæ­¢")
    else:
        print("ğŸ“Š ç›®å‰æ²’æœ‰é€²è¡Œä¸­çš„ä»»å‹™")

def show_help():
    """é¡¯ç¤ºå¹«åŠ©ä¿¡æ¯"""
    print("""
ğŸ¯ PDCA å¤šä»£ç†å”èª¿ç³»çµ±

ä½¿ç”¨æ–¹å¼ï¼š
  !pdca [ä»»å‹™æè¿°]     å•Ÿå‹• PDCA å”èª¿æµç¨‹
  !pdca status        æŸ¥çœ‹ç•¶å‰ä»»å‹™ç‹€æ…‹
  !pdca stop          åœæ­¢ç•¶å‰ä»»å‹™
  !pdca help          é¡¯ç¤ºæ­¤å¹«åŠ©

ç¯„ä¾‹ï¼š
  !pdca å»ºç«‹ç”¨æˆ¶ç™»å…¥ç³»çµ±
  !pdca å„ªåŒ–è³‡æ–™åº«æŸ¥è©¢æ•ˆèƒ½
  !pdca è¨­è¨ˆå¾®æœå‹™æ¶æ§‹

æ³¨æ„ï¼š
- ä½¿ç”¨ ! å‰ç¶´åœ¨ Claude CLI ä¸­åŸ·è¡Œ shell å‘½ä»¤
- ä»»å‹™å•Ÿå‹•å¾Œï¼ŒClaude æœƒä½œç‚ºå”èª¿è€…æ¥æ‰‹è™•ç†
- æ‚¨å¯ä»¥åœ¨å°è©±ä¸­ç¹¼çºŒèˆ‡ Claude äº’å‹•èª¿æ•´æ–¹å‘
    """)

def main():
    """ä¸»å…¥å£å‡½æ•¸"""
    args = sys.argv[1:]
    
    if not args:
        show_help()
        return
    
    command = args[0].lower()
    
    if command == "help" or command == "--help" or command == "-h":
        show_help()
    
    elif command == "status":
        show_status()
    
    elif command == "stop":
        stop_task()
    
    elif command == "start":
        print("ğŸš€ PDCA ç³»çµ±å·²æº–å‚™å°±ç·’")
        print("è«‹ä½¿ç”¨ !pdca [ä»»å‹™æè¿°] ä¾†å•Ÿå‹•å…·é«”ä»»å‹™")
    
    else:
        # å°‡ç¬¬ä¸€å€‹åƒæ•¸é–‹å§‹çš„æ‰€æœ‰å…§å®¹è¦–ç‚ºä»»å‹™æè¿°
        task_description = " ".join(args)
        task_data = create_task_file(task_description)
        
        print("ğŸ¯ PDCA ä»»å‹™å·²å•Ÿå‹•")
        print("=" * 40)
        print(f"ä»»å‹™: {task_description}")
        print(f"æ™‚é–“: {task_data['created_at']}")
        print("=" * 40)
        print()
        print("ğŸ“‹ Claude æ­£åœ¨ä½œç‚ºå”èª¿è€…æ¥æ‰‹è™•ç†...")
        print("ğŸ’¬ æ‚¨å¯ä»¥ç¹¼çºŒåœ¨å°è©±ä¸­èˆ‡ Claude äº’å‹•èª¿æ•´æ–¹å‘")
        print()
        print("ğŸ’¡ æç¤ºï¼š")
        print("  - ä½¿ç”¨ !pdca status æŸ¥çœ‹é€²åº¦")
        print("  - ä½¿ç”¨ !pdca stop åœæ­¢ä»»å‹™")
        print("  - ç›´æ¥èˆ‡ Claude å°è©±ä¾†ä»‹å…¥å’Œèª¿æ•´")

if __name__ == "__main__":
    main()