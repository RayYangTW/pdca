#!/usr/bin/env python3
"""
PDCA Shell åŸ·è¡Œè…³æœ¬
æ”¯æ´ Claude CLI çš„ !pdca æŒ‡ä»¤å‰ç¶´
"""

import sys
import json
import asyncio
from datetime import datetime
from pathlib import Path

# æ·»åŠ ç•¶å‰ç›®éŒ„åˆ° Python è·¯å¾‘
sys.path.insert(0, str(Path(__file__).parent))

def create_task_file(task_description):
    """å‰µå»ºä»»å‹™æª”æ¡ˆä¾› Claude è®€å–"""
    pdca_dir = Path(".pdca")
    pdca_dir.mkdir(exist_ok=True)
    
    task_data = {
        "task": task_description,
        "created_at": datetime.now().isoformat(),
        "status": "initiated",
        "source": "shell_command"
    }
    
    # ä¿å­˜ç•¶å‰ä»»å‹™
    with open(pdca_dir / "current_task.json", "w", encoding="utf-8") as f:
        json.dump(task_data, f, indent=2, ensure_ascii=False)
    
    return task_data

def show_status():
    """é¡¯ç¤ºç•¶å‰ä»»å‹™ç‹€æ…‹"""
    pdca_dir = Path(".pdca")
    current_task_file = pdca_dir / "current_task.json"
    
    if not current_task_file.exists():
        print("ğŸ“Š ç›®å‰æ²’æœ‰é€²è¡Œä¸­çš„ PDCA ä»»å‹™")
        return
    
    with open(current_task_file, "r", encoding="utf-8") as f:
        task_data = json.load(f)
    
    print("ğŸ“Š PDCA ä»»å‹™ç‹€æ…‹")
    print("=" * 40)
    print(f"ä»»å‹™: {task_data.get('task', 'N/A')}")
    print(f"ç‹€æ…‹: {task_data.get('status', 'unknown')}")
    print(f"å»ºç«‹æ™‚é–“: {task_data.get('created_at', 'N/A')}")

def stop_task():
    """åœæ­¢ç•¶å‰ä»»å‹™"""
    pdca_dir = Path(".pdca")
    current_task_file = pdca_dir / "current_task.json"
    
    if current_task_file.exists():
        current_task_file.unlink()
        print("ğŸ›‘ PDCA ä»»å‹™å·²åœæ­¢")
    else:
        print("ğŸ“Š ç›®å‰æ²’æœ‰é€²è¡Œä¸­çš„ä»»å‹™")

def show_help():
    """é¡¯ç¤ºå¹«åŠ©ä¿¡æ¯"""
    print("""
ğŸ¯ PDCA å¤šä»£ç†å”èª¿ç³»çµ±

ä½¿ç”¨æ–¹å¼ï¼š
  pdca [ä»»å‹™æè¿°]     å•Ÿå‹• PDCA å”èª¿æµç¨‹
  pdca status         æŸ¥çœ‹ç•¶å‰ä»»å‹™ç‹€æ…‹
  pdca stop           åœæ­¢ç•¶å‰ä»»å‹™
  pdca help           é¡¯ç¤ºæ­¤å¹«åŠ©

ç¯„ä¾‹ï¼š
  pdca å»ºç«‹ç”¨æˆ¶ç™»å…¥ç³»çµ±
  pdca å„ªåŒ–è³‡æ–™åº«æŸ¥è©¢æ•ˆèƒ½
  pdca è¨­è¨ˆå¾®æœå‹™æ¶æ§‹

èˆ‡ Claude æ•´åˆï¼š
  claude -p "$(pdca å»ºç«‹ç™»å…¥ç³»çµ±)"

æ³¨æ„ï¼š
- ç›´æ¥åŸ·è¡Œ pdca å‘½ä»¤æœƒè¼¸å‡ºå”èª¿å…§å®¹
- å¯é…åˆ claude -p ä½¿ç”¨ä¾†å•Ÿå‹• AI å”èª¿
- ä»»å‹™ç‹€æ…‹æœƒè¨˜éŒ„åœ¨ .pdca/ ç›®éŒ„ä¸­
    """)

def generate_pdca_output(task_description, enable_recorder=True):
    """ç”Ÿæˆ PDCA å”èª¿è¼¸å‡º"""
    output = f"""# ğŸ¯ PDCA å¤šä»£ç†å”èª¿ç³»çµ± 2.0

## ä»»å‹™ï¼š{task_description}

ä½œç‚º **[å”èª¿è€…]**ï¼Œæˆ‘å°‡å•Ÿå‹•äº”å¤§å°ˆå®¶å”ä½œä¾†è™•ç†é€™å€‹ä»»å‹™ï¼š

### ğŸ¨ [è¨­è¨ˆå°ˆå®¶] - æ¶æ§‹è¨­è¨ˆ
è«‹åˆ†æéœ€æ±‚ä¸¦æå‡ºæŠ€è¡“æ–¹æ¡ˆï¼Œè¨˜ä½è¦ï¼š
- ğŸ¤” è³ªç–‘è¨­è¨ˆæ±ºç­–çš„åˆç†æ€§
- ğŸ” æœå°‹æ¥­ç•Œæœ€ä½³å¯¦è¸
- ğŸ’ è¿½æ±‚å„ªé›…å¯æ“´å±•çš„æ¶æ§‹

### ğŸ’» [é–‹ç™¼å°ˆå®¶] - ç¨‹å¼å¯¦ä½œ
åŸºæ–¼è¨­è¨ˆæ–¹æ¡ˆé€²è¡Œå¯¦ä½œï¼Œç¢ºä¿ï¼š
- ğŸ¤” è³ªç–‘å¯¦ä½œæ–¹å¼æ˜¯å¦æœ€å„ª
- ğŸ” æœå°‹æœ€æ–°æŠ€è¡“å’Œå·¥å…·
- ğŸ’ è¿½æ±‚é«˜å“è³ªçš„ä»£ç¢¼

### ğŸ” [å“è³ªå°ˆå®¶] - æ¸¬è©¦é©—è­‰
é©—è­‰å¯¦ä½œå“è³ªï¼Œè¦æ±‚ï¼š
- ğŸ¤” è³ªç–‘æ¸¬è©¦è¦†è“‹ç‡æ˜¯å¦å……åˆ†
- ğŸ” æœå°‹æœ€æ–°æ¸¬è©¦æ–¹æ³•
- ğŸ’ è¿½æ±‚é›¶ç¼ºé™·å“è³ª

### ğŸš€ [å„ªåŒ–å°ˆå®¶] - æ€§èƒ½æ”¹å–„
åˆ†æä¸¦å„ªåŒ–ç³»çµ±ï¼Œæ³¨é‡ï¼š
- ğŸ¤” è³ªç–‘æ˜¯å¦è§£æ±ºæ ¹æœ¬å•é¡Œ
- ğŸ” æœå°‹å„ªåŒ–æœ€ä½³å¯¦è¸
- ğŸ’ è¿½æ±‚ç³»çµ±æ€§æ”¹å–„"""
    
    if enable_recorder:
        output += """

### ğŸ“ [è¨˜éŒ„ä»£ç†] - çŸ¥è­˜å®ˆè­·è€…
éåŒæ­¥è¨˜éŒ„æ‰€æœ‰äº’å‹•ï¼Œæ™ºèƒ½åˆ†é¡å­˜å„²ï¼š
- ğŸ¤” ç›£è½å°ˆå®¶è¨è«–å’Œæ±ºç­–éç¨‹
- ğŸ“Š åˆ†æé—œéµæ´å¯Ÿå’Œç¶“é©—æ•™è¨“
- ğŸ’¾ æ™ºèƒ½åˆ†é¡å­˜å„²åˆ°å°æ‡‰è¨˜æ†¶åº«
- ğŸ” å»ºç«‹çŸ¥è­˜ç´¢å¼•ä¾¿æ–¼æœªä¾†æŸ¥è©¢

è¨˜æ†¶åˆ†é¡ï¼š
- **decisions/** - é‡è¦æŠ€è¡“æ±ºç­–å’Œæ¶æ§‹é¸æ“‡
- **solutions/** - å…·é«”å•é¡Œçš„è§£æ±ºæ–¹æ¡ˆ
- **patterns/** - ç™¼ç¾çš„è¨­è¨ˆæ¨¡å¼å’Œæœ€ä½³å¯¦è¸
- **learnings/** - éŒ¯èª¤æ•™è¨“å’Œæ”¹é€²å¿ƒå¾—
- **progress/** - ä»»å‹™é€²åº¦å’Œé‡Œç¨‹ç¢‘è¨˜éŒ„"""
    
    output += f"""

## åŸ·è¡Œ PDCA å¾ªç’°
1. **Plan**: è¨­è¨ˆå°ˆå®¶åˆ†æéœ€æ±‚ï¼Œæå‡ºæ–¹æ¡ˆ
2. **Do**: é–‹ç™¼å°ˆå®¶å¯¦ä½œåŠŸèƒ½
3. **Check**: å“è³ªå°ˆå®¶é©—è­‰å“è³ª
4. **Act**: å„ªåŒ–å°ˆå®¶æå‡ºæ”¹å–„
5. **Record**: è¨˜éŒ„ä»£ç†æŒçºŒè¨˜éŒ„çŸ¥è­˜ï¼ˆéåŒæ­¥ï¼‰

è«‹é–‹å§‹å”èª¿è™•ç†ä»»å‹™ï¼š{task_description}"""
    
    return output

def main():
    """ä¸»å…¥å£å‡½æ•¸"""
    args = sys.argv[1:]
    
    if not args:
        show_help()
        return
    
    command = args[0].lower()
    
    if command == "help" or command == "--help" or command == "-h":
        show_help()
    
    elif command == "status":
        show_status()
    
    elif command == "stop":
        stop_task()
    
    else:
        # æª¢æŸ¥æ˜¯å¦æœ‰ --no-recorder åƒæ•¸
        enable_recorder = True
        filtered_args = []
        
        for arg in args:
            if arg == "--no-recorder":
                enable_recorder = False
            else:
                filtered_args.append(arg)
        
        # å°‡éæ¿¾å¾Œçš„åƒæ•¸è¦–ç‚ºä»»å‹™æè¿°
        task_description = " ".join(filtered_args)
        
        # å‰µå»ºä»»å‹™æª”æ¡ˆï¼ˆè¨˜éŒ„ç”¨ï¼‰
        task_data = create_task_file(task_description)
        
        # å¦‚æœå•Ÿç”¨è¨˜éŒ„ä»£ç†ï¼Œå‰µå»ºè¨˜æ†¶åˆ†é¡ç›®éŒ„
        if enable_recorder:
            memories_dir = Path("memories")
            for subdir in ["decisions", "solutions", "patterns", "learnings", "progress"]:
                (memories_dir / subdir).mkdir(parents=True, exist_ok=True)
        
        # ç›´æ¥è¼¸å‡º PDCA å”èª¿å…§å®¹
        print(generate_pdca_output(task_description, enable_recorder))

if __name__ == "__main__":
    main()