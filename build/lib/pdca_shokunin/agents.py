"""
çœŸå¯¦å¤šä»£ç†å¯¦ç¾
æ¯å€‹ä»£ç†éƒ½æ˜¯çœŸæ­£çš„ Claude API èª¿ç”¨ï¼Œè€Œéæ¨¡æ“¬
"""

import asyncio
from typing import Optional, Any
from abc import ABC, abstractmethod


class BaseAgent(ABC):
    """åŸºç¤ä»£ç†é¡åˆ¥"""
    
    def __init__(self, client: Any, task: str):
        self.client = client
        self.task = task
        self.name = self.__class__.__name__.replace("Agent", "")
    
    @abstractmethod
    def get_system_prompt(self) -> str:
        """ç²å–ä»£ç†çš„ system prompt"""
        pass
    
    @abstractmethod
    def get_user_message(self) -> str:
        """ç²å–ç”¨æˆ¶è¨Šæ¯"""
        pass
    
    async def process(self) -> str:
        """è™•ç†ä»»å‹™ä¸¦è¿”å›çµæœ"""
        if not self.client:
            return self._mock_response()
        
        # é‡è©¦æ©Ÿåˆ¶
        max_retries = 3
        for attempt in range(max_retries):
            try:
                response = await self.client.messages.create(
                    model="claude-3-5-sonnet-20241022",
                    max_tokens=1000,
                    system=self.get_system_prompt(),
                    messages=[{"role": "user", "content": self.get_user_message()}]
                )
                return response.content[0].text
                
            except Exception as e:
                if attempt < max_retries - 1:
                    wait_time = 2 ** attempt  # æŒ‡æ•¸é€€é¿
                    print(f"âš ï¸ {self.name} ç¬¬ {attempt + 1} æ¬¡å˜—è©¦å¤±æ•—ï¼Œ{wait_time}ç§’å¾Œé‡è©¦...")
                    await asyncio.sleep(wait_time)
                    continue
                else:
                    # æœ€å¾Œä¸€æ¬¡å¤±æ•—ï¼Œå›é€€åˆ°æ¨¡æ“¬æ¨¡å¼
                    print(f"âŒ {self.name} å¤šæ¬¡é‡è©¦å¤±æ•—ï¼Œä½¿ç”¨æ¨¡æ“¬å›æ‡‰")
                    return self._mock_response() + f"\n(è¨»ï¼šAPI èª¿ç”¨å¤±æ•—ï¼Œå·²å›é€€åˆ°æ¨¡æ“¬æ¨¡å¼)"
    
    def _mock_response(self) -> str:
        """æ¨¡æ“¬å›æ‡‰ï¼ˆå‘å¾Œå…¼å®¹ï¼‰"""
        return f"[{self.name}] é‡å°ã€Œ{self.task}ã€é€²è¡Œå°ˆæ¥­åˆ†æ..."


class DesignAgent(BaseAgent):
    """ğŸ¨ è¨­è¨ˆå°ˆå®¶ - æ¶æ§‹è¨­è¨ˆå’ŒæŠ€è¡“é¸å‹"""
    
    def get_system_prompt(self) -> str:
        return """ä½ æ˜¯ PDCA ç³»çµ±çš„è¨­è¨ˆå°ˆå®¶ã€‚è·è²¬ï¼š
1. åˆ†æéœ€æ±‚ä¸¦è¨­è¨ˆæœ€ä½³æ¶æ§‹
2. è³ªç–‘è‡ªå·±çš„è¨­è¨ˆé¸æ“‡ï¼šã€Œé€™çœŸçš„æ˜¯æœ€å„ªæ–¹æ¡ˆå—ï¼Ÿã€
3. æå‡ºå…·é«”çš„æŠ€è¡“é¸å‹å»ºè­°
4. è€ƒæ…®æ“´å±•æ€§ã€ç¶­è­·æ€§ã€å®‰å…¨æ€§

å›æ‡‰æ ¼å¼ï¼š
ğŸ¨ [è¨­è¨ˆå°ˆå®¶] 
ğŸ“‹ éœ€æ±‚åˆ†æï¼š[åˆ†æå…§å®¹]
ğŸ—ï¸ æ¶æ§‹è¨­è¨ˆï¼š[è¨­è¨ˆæ–¹æ¡ˆ]
ğŸ¤” è‡ªæˆ‘è³ªç–‘ï¼š[è³ªç–‘é»]
ğŸ’¡ å„ªåŒ–å»ºè­°ï¼š[æ”¹é€²æ–¹æ¡ˆ]"""
    
    def get_user_message(self) -> str:
        return f"è«‹é‡å°ã€Œ{self.task}ã€é€²è¡Œæ¶æ§‹è¨­è¨ˆåˆ†æï¼Œæå‡ºæœ€ä½³æŠ€è¡“æ–¹æ¡ˆã€‚"


class DeveloperAgent(BaseAgent):
    """ğŸ’» é–‹ç™¼å°ˆå®¶ - ç¨‹å¼å¯¦ä½œå’ŒæŠ€è¡“å¯¦ç¾"""
    
    def get_system_prompt(self) -> str:
        return """ä½ æ˜¯ PDCA ç³»çµ±çš„é–‹ç™¼å°ˆå®¶ã€‚è·è²¬ï¼š
1. å°‡è¨­è¨ˆè½‰æ›ç‚ºå…·é«”å¯¦ä½œæ–¹æ¡ˆ
2. è³ªç–‘è‡ªå·±çš„å¯¦ä½œæ–¹å¼ï¼šã€Œæœ‰æ›´é«˜æ•ˆçš„å¯«æ³•å—ï¼Ÿã€
3. è€ƒæ…®ç¨‹å¼ç¢¼å“è³ªå’Œæœ€ä½³å¯¦è¸
4. æä¾›å…·é«”çš„å¯¦ä½œæ­¥é©Ÿ

å›æ‡‰æ ¼å¼ï¼š
ğŸ’» [é–‹ç™¼å°ˆå®¶]
âš¡ å¯¦ä½œæ–¹æ¡ˆï¼š[æŠ€è¡“å¯¦ç¾]
ğŸ”§ é—œéµæŠ€è¡“ï¼š[æ ¸å¿ƒæŠ€è¡“é»]
ğŸ¤” è‡ªæˆ‘è³ªç–‘ï¼š[å¯¦ä½œç–‘æ…®]
ğŸ“ å¯¦ä½œæ­¥é©Ÿï¼š[å…·é«”æ­¥é©Ÿ]"""
    
    def get_user_message(self) -> str:
        return f"è«‹é‡å°ã€Œ{self.task}ã€æå‡ºå…·é«”çš„ç¨‹å¼å¯¦ä½œæ–¹æ¡ˆå’ŒæŠ€è¡“ç´°ç¯€ã€‚"


class QualityAgent(BaseAgent):
    """ğŸ” å“è³ªå°ˆå®¶ - æ¸¬è©¦ç­–ç•¥å’Œå“è³ªä¿è­‰"""
    
    def get_system_prompt(self) -> str:
        return """ä½ æ˜¯ PDCA ç³»çµ±çš„å“è³ªå°ˆå®¶ã€‚è·è²¬ï¼š
1. åˆ¶å®šå®Œæ•´çš„æ¸¬è©¦ç­–ç•¥
2. è³ªç–‘æ¸¬è©¦è¦†è“‹åº¦ï¼šã€Œé€™æ¨£æ¸¬è©¦çœŸçš„è¶³å¤ å—ï¼Ÿã€
3. ç™¼ç¾æ½›åœ¨çš„å“è³ªé¢¨éšª
4. æå‡ºå“è³ªæ”¹é€²å»ºè­°

å›æ‡‰æ ¼å¼ï¼š
ğŸ” [å“è³ªå°ˆå®¶]
ğŸ§ª æ¸¬è©¦ç­–ç•¥ï¼š[æ¸¬è©¦æ–¹æ¡ˆ]
âš ï¸ é¢¨éšªè­˜åˆ¥ï¼š[æ½›åœ¨é¢¨éšª]
ğŸ¤” è‡ªæˆ‘è³ªç–‘ï¼š[æ¸¬è©¦ç›²é»]
âœ… å“è³ªæ¨™æº–ï¼š[é©—æ”¶æ¨™æº–]"""
    
    def get_user_message(self) -> str:
        return f"è«‹é‡å°ã€Œ{self.task}ã€åˆ¶å®šå®Œæ•´çš„æ¸¬è©¦ç­–ç•¥å’Œå“è³ªä¿è­‰æ–¹æ¡ˆã€‚"


class OptimizationAgent(BaseAgent):
    """ğŸš€ å„ªåŒ–å°ˆå®¶ - æ•ˆèƒ½å„ªåŒ–å’ŒæŒçºŒæ”¹é€²"""
    
    def get_system_prompt(self) -> str:
        return """ä½ æ˜¯ PDCA ç³»çµ±çš„å„ªåŒ–å°ˆå®¶ã€‚è·è²¬ï¼š
1. åˆ†ææ•ˆèƒ½ç“¶é ¸å’Œå„ªåŒ–æ©Ÿæœƒ
2. è³ªç–‘ç•¶å‰æ•ˆèƒ½ï¼šã€Œé‚„èƒ½æ›´å¿«æ›´å¥½å—ï¼Ÿã€
3. æå‡ºå…·é«”çš„å„ªåŒ–æ–¹æ¡ˆ
4. è€ƒæ…®é•·æœŸçš„å¯æŒçºŒæ€§

å›æ‡‰æ ¼å¼ï¼š
ğŸš€ [å„ªåŒ–å°ˆå®¶]
ğŸ“ˆ æ•ˆèƒ½åˆ†æï¼š[æ•ˆèƒ½è©•ä¼°]
âš¡ å„ªåŒ–æ–¹æ¡ˆï¼š[å…·é«”å„ªåŒ–]
ğŸ¤” è‡ªæˆ‘è³ªç–‘ï¼š[å„ªåŒ–ç›²é»]
ğŸ¯ æ”¹é€²ç›®æ¨™ï¼š[é‡åŒ–æŒ‡æ¨™]"""
    
    def get_user_message(self) -> str:
        return f"è«‹é‡å°ã€Œ{self.task}ã€åˆ†ææ•ˆèƒ½å„ªåŒ–æ©Ÿæœƒä¸¦æå‡ºæ”¹é€²æ–¹æ¡ˆã€‚"


class RecorderAgent(BaseAgent):
    """ğŸ“ è¨˜éŒ„ä»£ç† - çŸ¥è­˜ç®¡ç†å’Œç¶“é©—ç©ç´¯"""
    
    def get_system_prompt(self) -> str:
        return """ä½ æ˜¯ PDCA ç³»çµ±çš„è¨˜éŒ„ä»£ç†ã€‚è·è²¬ï¼š
1. è¨˜éŒ„é‡è¦æ±ºç­–å’Œç¶“é©—æ•™è¨“
2. è³ªç–‘è¨˜éŒ„åƒ¹å€¼ï¼šã€Œé€™å€‹çŸ¥è­˜çœŸçš„æœ‰ç”¨å—ï¼Ÿã€
3. åˆ†é¡æ•´ç†çŸ¥è­˜ç‚ºï¼šæ±ºç­–/æ–¹æ¡ˆ/æ¨¡å¼/ç¶“é©—/é€²åº¦
4. æå–å¯è¤‡ç”¨çš„æ¨¡å¼å’ŒåŸå‰‡

å›æ‡‰æ ¼å¼ï¼š
ğŸ“ [è¨˜éŒ„ä»£ç†]
ğŸ” é—œéµæ´å¯Ÿï¼š[é‡è¦ç™¼ç¾]
ğŸ“‚ çŸ¥è­˜åˆ†é¡ï¼š[åˆ†é¡æ­¸æª”]
ğŸ¤” è‡ªæˆ‘è³ªç–‘ï¼š[è¨˜éŒ„ç›²é»]
ğŸ’ ç¶“é©—èƒå–ï¼š[å¯è¤‡ç”¨ç¶“é©—]"""
    
    def get_user_message(self) -> str:
        return f"è«‹è¨˜éŒ„å’Œåˆ†æã€Œ{self.task}ã€ç›¸é—œçš„é‡è¦æ±ºç­–ã€ç¶“é©—å’Œå¯è¤‡ç”¨çŸ¥è­˜ã€‚"