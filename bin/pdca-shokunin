#!/usr/bin/env node

/**
 * PDCA-Shokunin CLI
 * è·äººç´šå¤šä»£ç†å”èª¿ç³»çµ± - Node.js åŸ·è¡Œå…¥å£
 */

const { spawn } = require('child_process');
const path = require('path');
const fs = require('fs');
const chalk = require('chalk');
const commander = require('commander');
const ora = require('ora');

const program = new commander.Command();

// ç‰ˆæœ¬è³‡è¨Š
program
  .name('pdca-shokunin')
  .description('ğŸŒ PDCA-Shokunin è·äººç´šå¤šä»£ç†å”èª¿ç³»çµ±')
  .version('3.0.0');

// ä¸»å‘½ä»¤ï¼šå•Ÿå‹• PDCA ç³»çµ±
program
  .argument('<task>', 'ä»»å‹™æè¿°')
  .option('-d, --detach', 'èƒŒæ™¯åŸ·è¡Œ')
  .option('-m, --monitor', 'ç›´æ¥é€²å…¥ç›£æ§æ¨¡å¼')
  .option('--no-color', 'é—œé–‰é¡è‰²è¼¸å‡º')
  .action((task, options) => {
    startPDCA(task, options);
  });

// init å­å‘½ä»¤ï¼šåˆå§‹åŒ–ç•¶å‰å°ˆæ¡ˆ
program
  .command('init')
  .description('åœ¨ç•¶å‰å°ˆæ¡ˆåˆå§‹åŒ– PDCA-Shokunin')
  .option('-f, --force', 'å¼·åˆ¶è¦†è“‹ç¾æœ‰é…ç½®')
  .action((options) => {
    initProject(options);
  });

// status å­å‘½ä»¤ï¼šæŸ¥çœ‹é‹è¡Œç‹€æ…‹
program
  .command('status')
  .description('æŸ¥çœ‹ PDCA-Shokunin é‹è¡Œç‹€æ…‹')
  .action(() => {
    checkStatus();
  });

// stop å­å‘½ä»¤ï¼šåœæ­¢ç³»çµ±
program
  .command('stop')
  .description('åœæ­¢ PDCA-Shokunin ç³»çµ±')
  .action(() => {
    stopSystem();
  });

// è§£æå‘½ä»¤è¡Œåƒæ•¸
program.parse();

/**
 * å•Ÿå‹• PDCA ç³»çµ±
 */
function startPDCA(task, options) {
  console.log(chalk.blue.bold('ğŸŒ PDCA-Shokunin Multi-Agent System'));
  console.log(chalk.gray('â•'.repeat(50)));
  console.log(chalk.yellow(`ğŸ“‹ ä»»å‹™: ${task}`));
  console.log();

  const spinner = ora('æª¢æŸ¥ç³»çµ±éœ€æ±‚...').start();

  // æª¢æŸ¥ Python
  const pythonCheck = spawn('python3', ['--version']);
  pythonCheck.on('error', () => {
    spinner.fail('Python 3 æœªå®‰è£');
    console.log(chalk.red('è«‹å®‰è£ Python 3.8 æˆ–æ›´é«˜ç‰ˆæœ¬'));
    process.exit(1);
  });

  pythonCheck.on('close', (code) => {
    if (code !== 0) {
      spinner.fail('Python æª¢æŸ¥å¤±æ•—');
      process.exit(1);
    }

    // æª¢æŸ¥ tmux
    const tmuxCheck = spawn('tmux', ['-V']);
    tmuxCheck.on('error', () => {
      spinner.fail('tmux æœªå®‰è£');
      console.log(chalk.red('è«‹å®‰è£ tmux:'));
      console.log('  macOS: brew install tmux');
      console.log('  Ubuntu: sudo apt install tmux');
      process.exit(1);
    });

    tmuxCheck.on('close', (code) => {
      if (code !== 0) {
        spinner.fail('tmux æª¢æŸ¥å¤±æ•—');
        process.exit(1);
      }

      spinner.succeed('ç³»çµ±éœ€æ±‚æª¢æŸ¥å®Œæˆ');

      // æŸ¥æ‰¾ launcher.py è·¯å¾‘
      const launcherPath = findLauncherPath();
      if (!launcherPath) {
        console.log(chalk.red('âŒ æ‰¾ä¸åˆ° launcher.py'));
        console.log(chalk.yellow('è«‹å…ˆåŸ·è¡Œ: pdca-shokunin init'));
        process.exit(1);
      }

      // å•Ÿå‹•ç³»çµ±
      console.log();
      spinner.start('å•Ÿå‹• PDCA-Shokunin ç³»çµ±...');

      const pdca = spawn('python3', [launcherPath, task], {
        stdio: 'inherit'
      });

      pdca.on('error', (err) => {
        spinner.fail('å•Ÿå‹•å¤±æ•—');
        console.error(err);
        process.exit(1);
      });

      pdca.on('close', (code) => {
        if (code === 0) {
          spinner.succeed('ç³»çµ±å•Ÿå‹•å®Œæˆ');
          if (!options.detach) {
            console.log(chalk.green('\nâœ¨ ä½¿ç”¨ tmux attach -t pdca-shokunin æŸ¥çœ‹ç‹€æ…‹'));
          }
        } else {
          spinner.fail('ç³»çµ±å•Ÿå‹•å¤±æ•—');
          process.exit(code);
        }
      });
    });
  });
}

/**
 * åˆå§‹åŒ–å°ˆæ¡ˆ
 */
function initProject(options) {
  const spinner = ora('åˆå§‹åŒ– PDCA-Shokunin...').start();

  // åŸ·è¡Œ setup è…³æœ¬
  const setupPath = path.join(__dirname, '..', 'scripts', 'setup.js');
  const setup = spawn('node', [setupPath, options.force ? '--force' : ''], {
    stdio: 'inherit'
  });

  setup.on('close', (code) => {
    if (code === 0) {
      spinner.succeed('åˆå§‹åŒ–å®Œæˆ');
      console.log(chalk.green('\nâœ… PDCA-Shokunin å·²æº–å‚™å°±ç·’ï¼'));
      console.log(chalk.blue('ä½¿ç”¨æ–¹æ³•:'));
      console.log('  pdca-shokunin "ä½ çš„ä»»å‹™"');
      console.log('  æˆ–åœ¨ Claude CLI ä¸­: /pdca "ä½ çš„ä»»å‹™"');
    } else {
      spinner.fail('åˆå§‹åŒ–å¤±æ•—');
      process.exit(code);
    }
  });
}

/**
 * æª¢æŸ¥é‹è¡Œç‹€æ…‹
 */
function checkStatus() {
  const tmux = spawn('tmux', ['has-session', '-t', 'pdca-shokunin']);
  
  tmux.on('close', (code) => {
    if (code === 0) {
      console.log(chalk.green('âœ“ PDCA-Shokunin æ­£åœ¨é‹è¡Œ'));
      
      // åˆ—å‡ºçª—å£
      const listWindows = spawn('tmux', ['list-windows', '-t', 'pdca-shokunin'], {
        stdio: 'pipe'
      });
      
      listWindows.stdout.on('data', (data) => {
        console.log(chalk.gray('\nçª—å£åˆ—è¡¨:'));
        console.log(data.toString());
      });
    } else {
      console.log(chalk.yellow('âš  PDCA-Shokunin æœªé‹è¡Œ'));
    }
  });
}

/**
 * åœæ­¢ç³»çµ±
 */
function stopSystem() {
  const spinner = ora('åœæ­¢ PDCA-Shokunin...').start();
  
  const kill = spawn('tmux', ['kill-session', '-t', 'pdca-shokunin']);
  
  kill.on('close', (code) => {
    if (code === 0) {
      spinner.succeed('ç³»çµ±å·²åœæ­¢');
    } else {
      spinner.fail('åœæ­¢å¤±æ•—ï¼ˆå¯èƒ½ç³»çµ±æœªé‹è¡Œï¼‰');
    }
  });
}

/**
 * æŸ¥æ‰¾ launcher.py è·¯å¾‘
 */
function findLauncherPath() {
  // å„ªå…ˆé †åºï¼š
  // 1. ç•¶å‰ç›®éŒ„çš„ .pdca-shokunin/launcher.py
  // 2. npm å…¨å±€å®‰è£ç›®éŒ„
  // 3. npm æœ¬åœ°å®‰è£ç›®éŒ„
  
  const paths = [
    path.join(process.cwd(), '.pdca-shokunin', 'launcher.py'),
    path.join(__dirname, '..', '.pdca-shokunin', 'launcher.py'),
    path.join(process.env.HOME, '.pdca-shokunin', 'launcher.py')
  ];
  
  for (const p of paths) {
    if (fs.existsSync(p)) {
      return p;
    }
  }
  
  return null;
}